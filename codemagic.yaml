workflows:
  kivy-ios-unsigned:
    name: Beluga Chat
    environment:
      xcode: latest
      vars:
        APP_NAME: "beluga_chat_sapp"
        BUNDLE_ID: "com.beluga.chatt"

    scripts:
      - name: CÃ i cÃ´ng cá»¥ build & automake
        script: |
          brew update
          brew install automake libtool pkg-config
          echo "âœ… Kiá»ƒm tra automake:"
          automake --version || { echo "âŒ Automake khÃ´ng cÃ i Ä‘Æ°á»£c!"; exit 1; }

      - name: CÃ i Python vÃ  pip
        script: |
          brew install python
          pip3 install --upgrade pip
          pip3 install virtualenv

      - name: CÃ i kivy-ios
        script: |
          pip3 install kivy-ios

      - name: Build dependencies vá»›i debug chi tiáº¿t
        script: |
          cd $CM_BUILD_DIR
          mkdir -p iosbuild
          cd iosbuild

          echo "ðŸŒ Táº£i trÆ°á»›c openssl Ä‘á»ƒ trÃ¡nh lá»—i máº¡ng"
          mkdir -p .cache
          curl -L -o .cache/hostopenssl-openssl-1.1.1w.tar.gz https://www.openssl.org/source/openssl-1.1.1w.tar.gz

          echo "ðŸ”§ Giá»›i háº¡n sá»‘ job vá» 2 Ä‘á»ƒ giáº£m RAM"
          export KIVY_IOS_JOBS=2

          echo "ðŸ“¦ Build hostopenssl..."
          toolchain build hostopenssl || { echo "âŒ Build hostopenssl failed"; exit 1; }

          echo "ðŸ“¦ Build libffi..."
          toolchain build libffi || { echo "âŒ Build libffi failed"; exit 1; }

          echo "ðŸ“¦ Build openssl..."
          toolchain build openssl || { echo "âŒ Build openssl failed"; exit 1; }

          echo "ðŸ“¦ Build hostpython3..."
          toolchain build hostpython3 || { echo "âŒ Build hostpython3 failed"; exit 1; }

          echo "ðŸ“¦ Build python3..."
          toolchain build python3 || { 
            echo "âŒ Build python3 failed"; 
            echo "ðŸ“ Kiá»ƒm tra thÆ° má»¥c .cache:"
            ls -lhR .cache
            echo "ðŸ“ Kiá»ƒm tra dung lÆ°á»£ng á»• Ä‘Ä©a:"
            df -h
            exit 1; 
          }

          echo "ðŸ“¦ Build kivy..."
          toolchain build kivy || { echo "âŒ Build kivy failed"; exit 1; }

      - name: Táº¡o project tá»« main.py
        script: |
          cd $CM_BUILD_DIR/iosbuild
          echo "ðŸ“ Kiá»ƒm tra workspace:"
          ls -la ../

          if [ -f "../kivy_chat_app/main.py" ]; then
            echo "âœ… Found main.py trong kivy_chat_app"
            toolchain create $APP_NAME ../kivy_chat_app/main.py
          elif [ -f "../main.py" ]; then
            echo "âœ… Found main.py trong thÆ° má»¥c gá»‘c"
            toolchain create $APP_NAME ../main.py
          else
            echo "âŒ KhÃ´ng tÃ¬m tháº¥y main.py"
            exit 1
          fi

      - name: Táº¡o Xcode project & sá»­a Bundle ID
        script: |
          cd $CM_BUILD_DIR/iosbuild
          toolchain xcode $APP_NAME
          cd $CM_BUILD_DIR/iosbuild/$APP_NAME-ios

          echo "ðŸ“ Kiá»ƒm tra cáº¥u trÃºc thÆ° má»¥c:"
          ls -la
          echo "ðŸ“ BÃªn trong thÆ° má»¥c app:"
          ls -la $APP_NAME/

          if [ -f "$APP_NAME/Info.plist" ]; then
            /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $BUNDLE_ID" "$APP_NAME/Info.plist"
            echo "âœ… Bundle ID Ä‘Ã£ Ä‘Æ°á»£c sá»­a"
          elif [ -f "$APP_NAME/$APP_NAME-Info.plist" ]; then
            /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $BUNDLE_ID" "$APP_NAME/$APP_NAME-Info.plist"
            echo "âœ… Bundle ID Ä‘Ã£ Ä‘Æ°á»£c sá»­a (file -Info.plist)"
          else
            echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y Info.plist"
            find . -name "Info.plist" -o -name "*-Info.plist"
          fi

      - name: Build IPA unsigned
        script: |
          cd $CM_BUILD_DIR/iosbuild/$APP_NAME-ios

          echo "ðŸ“¦ Báº¯t Ä‘áº§u build archive"
          xcodebuild -scheme $APP_NAME -configuration Release -archivePath $APP_NAME.xcarchive archive CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

          echo "ðŸ“¦ Táº¡o exportOptions.plist"
          cat > exportOptions.plist << EOL
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>signingStyle</key>
            <string>manual</string>
          </dict>
          </plist>
          EOL

          echo "ðŸ“¦ Export IPA"
          xcodebuild -exportArchive -archivePath $APP_NAME.xcarchive -exportOptionsPlist exportOptions.plist -exportPath build/Release-iphoneos CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

          echo "ðŸ“¦ Kiá»ƒm tra IPA:"
          find build -name "*.ipa"

    artifacts:
      - iosbuild/$APP_NAME-ios/build/Release-iphoneos/*.ipa
